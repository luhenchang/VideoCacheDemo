import { ComponentContent, promptAction, PromptAction, router, window } from '@kit.ArkUI';
import { VideoContentInfo } from '../../data/VideoContentInfo';
import { VideoModel } from '../../data/VideoModel';
import { VideoTimeUtil } from '../../utils/VideoTimeUtil';
import { BusinessError } from '@kit.BasicServicesKit';
import { throttle } from '../../utils/Threottle';
import { common } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { SendVideoState } from '../AMPSVideoCachePage';
import { JumpThreadAppState } from './ThreaWayAdView';
import { PrDialogContentView } from './PrDialogContentView';

export enum GetRewardedState {
  NOT_OBTAINABLE, //é»˜è®¤æ²¡æœ‰è·å¾—å¥–åŠ±
  NOW_GET_REWARDED, //ç«‹å³è·å–å¥–åŠ±
  ALREADY_OBTAINED //å·²ç»è·å¾—äº†å¥–åŠ±
}

//privilegePopUpStatus
export enum PrivilegeDialogStatus {
  OPENING,
  CLOSE
}

@Preview
@Component
export struct TimeDownAndCloseView {
  @State
  jumpTime: number = 0
  @State
  optimizeTime: number = 0
  @State
  showTime: number = 0
  @State
  optimizeType: number = 0
  @Watch('updateViewModel')                                @Prop videoModel: VideoModel
  @Consume('videoState')
  videoState: SendVideoState
  @Watch('jumpThreadAppListener') @Consume('jumpThreadAppState')
  jumpThreadAppState: JumpThreadAppState
  @State timeDown: number = 0
  @State minTime: number = 0
  @State intervalId: number | undefined = undefined
  @State rewardState: GetRewardedState = GetRewardedState.NOT_OBTAINABLE
  @State intervalFlag: boolean = false
  @State plgDialogState: PrivilegeDialogStatus = PrivilegeDialogStatus.CLOSE

  aboutToAppear(): void {
    this.updateViewModel()
  }

  aboutToDisappear(): void {
    let context = getContext(this) as common.UIAbilityContext;
    this.rewardState = GetRewardedState.NOT_OBTAINABLE
    this.videoState = SendVideoState.COMPLETE;
    context.windowStage.off('windowStageEvent')
    clearInterval(this.intervalId);
  }

  //æ’­æ”¾å®Œæˆï¼Œæˆ–è€…å·²ç»è·å–å¥–åŠ±ç‚¹å‡»è·³è½¬==ã€‹æ˜¾ç¤ºå¹¿å‘Šé¡µé¢
  private finishPlayAndJumpFullAd() {
    this.videoState = SendVideoState.COMPLETE;
    clearInterval(this.intervalId);
  }

  build() {
    if (this.videoModel)
    Row() {
      if (this.optimizeType === 0) {
        if (this.rewardState === GetRewardedState.ALREADY_OBTAINED) {
          Text("å·²è·å¾—å¥–åŠ±").fontColor(Color.White).fontSize(14)
        } else {
          Text(this.minTime + "ç§’ä¹‹åé¢†å–å¥–åŠ±").fontColor(Color.White).fontSize(14)
        }
      } else if (this.optimizeType === 1) {
        if (this.rewardState === GetRewardedState.ALREADY_OBTAINED) {
          Text("ğŸ å·²è·å¾—å¥–åŠ±").fontColor(Color.White).fontSize(14)
        } else if (this.rewardState === GetRewardedState.NOW_GET_REWARDED) {
          Text("ğŸ ç«‹å³é¢†å–").fontColor(Color.White).fontSize(14)
        } else {
          Text("ğŸ " + this.optimizeTime + "ç§’åç‚¹å‡»å¹¿å‘Šå¯é¢†å–å¥–åŠ±").fontColor(Color.White).fontSize(14)
        }
      }
      Text("  |  ").fontColor(Color.White)
      if (this.videoState === SendVideoState.COMPLETE) {
        Text("å…³é—­").fontColor(Color.White).fontSize(14).onClick(throttle(() => {
          clearInterval(this.intervalId)
          router.back()
        }, 1000))
      } else {
        Text("è·³è¿‡").fontColor(Color.White).fontSize(14).onClick(throttle(() => {
          if (this.rewardState === GetRewardedState.ALREADY_OBTAINED) {
            //å»åœæ­¢æ’­æ”¾ã€å¼¹å‡ºé¡µé¢
            this.videoState = SendVideoState.COMPLETE
            clearInterval(this.intervalId)
          } else {
            if (this.videoState === SendVideoState.PLAYING) {
              this.videoState = SendVideoState.PAUSED
            }
            let uiContext = this.getUIContext();
            let promptAction = uiContext.getPromptAction();
            let title = "ä»…éœ€" + this.minTime + "ç§’å³å¯è·å¾—å¥–åŠ±"
            let sub = "ç¡®å®šè¦é€€å‡ºä¹ˆ"
            let contentNode =
              new ComponentContent(uiContext, wrapBuilder(buildText),
                new Params(title, sub, 0, this.videoModel, (state: JumpThreadAppState) => {
                  this.jumpThreadAppState = state
                }, () => {
                  if (this.videoState === SendVideoState.PAUSED) {
                    this.videoState = SendVideoState.PLAYING
                  }
                  promptAction.closeCustomDialog(contentNode)
                }, () => {

                }, () => {
                  promptAction.closeCustomDialog(contentNode)
                  clearInterval(this.intervalId)
                  router.back()
                }));
            let options: promptAction.BaseDialogOptions = {
              alignment: DialogAlignment.Center,
              isModal: true,
              maskColor: "#7e090909",
              autoCancel: false
            };
            try {
              promptAction.openCustomDialog(contentNode, options);
            } catch (error) {
              let message = (error as BusinessError).message;
              let code = (error as BusinessError).code;
              console.error(`OpenCustomDialog args error code is ${code}, message is ${message}`);
            }
          }
        }, 1000))
      }

    }
    .padding({
      left: 10,
      right: 10,
      top: 4,
      bottom: 4
    })
    .backgroundColor("#5b1d1d1d")
    .border({ radius: 20, color: "#baefecec", width: 0.85 })
  }

  updateViewModel() {
    console.info("aboutToApper videoModel====" + this.videoModel + "==flag=" + this.intervalFlag)
    if (!this.videoModel || this.intervalFlag === true) {
      return
    }
    this.optimizeType = VideoTimeUtil.getOptimizeType(this.videoModel)
    this.optimizeTime = VideoTimeUtil.getOptimizeTime(this.videoModel)
    this.showTime = VideoTimeUtil.getShowTime(this.videoModel)
    //æ§åˆ¶æœ‰ä¸”åªæœ‰ä¸€æ¬¡åˆå§‹åŒ–ã€çŠ¶æ€ã€timeDowã€minTimeã€intervalã€‘
    this.intervalFlag = true
    this.videoState = SendVideoState.PLAYING
    this.timeDown = VideoTimeUtil.getTimeDown(this.videoModel)
    this.minTime = VideoTimeUtil.getMinTime(this.videoModel)
    if (this.optimizeType === 0) {
      this.intervalId = setInterval(() => {
        if (this.videoState != SendVideoState.PAUSED) {
          this.timeDown -= 1
          this.minTime -= 1

          if (this.minTime < 1) {
            this.rewardState = GetRewardedState.ALREADY_OBTAINED
          }
          if (this.timeDown < 1) {
            //å»åœæ­¢æ’­æ”¾ã€å¼¹å‡ºé¡µé¢
            this.finishPlayAndJumpFullAd();
          }
        }

      }, 1000)
    } else if (this.optimizeType === 1) {
      this.intervalId = setInterval(() => {
        if (this.videoState != SendVideoState.PAUSED) {
          this.timeDown -= 1
          this.minTime -= 1
          if (this.optimizeTime > 0) {
            this.optimizeTime -= 1
          }
          console.log("this.optimizeTime==" + this.optimizeTime)
          if (this.optimizeTime === 0 && this.rewardState === GetRewardedState.NOT_OBTAINABLE) {
            this.rewardState = GetRewardedState.NOW_GET_REWARDED
          }
          if (this.minTime < 1) {
            this.rewardState = GetRewardedState.ALREADY_OBTAINED
          }

          if (this.timeDown < 1) {
            //å»åœæ­¢æ’­æ”¾ã€å¼¹å‡ºé¡µé¢
            this.finishPlayAndJumpFullAd();
          }
        }

      }, 1000)
    } else if (this.optimizeType === 2) {

    }
    if (this.optimizeType === 0) {
      this.windowStageEvent();
    } else if (this.optimizeType === 1) {
      console.log("æ³¨å†Œæ¬¡æ•°")
      this.windowStageEventTypeOne()
    }
  }

  /**
   * æ ¹æ®è¿›å…¥åå°ç­‰è¿›è¡Œç›¸å…³çŠ¶æ€æ“ä½œã€‚
   */
  private windowStageEvent() {
    let context = getContext(this) as common.UIAbilityContext;

    context.windowStage.on('windowStageEvent', async (data) => {
      let stageEventType: window.WindowStageEventType = data;
      switch (stageEventType) {
        case window.WindowStageEventType.SHOWN: // åˆ‡åˆ°å‰å°
          hilog.info(0x0000, 'testTag', `windowStage foreground.`);
          if (this.videoState === SendVideoState.PAUSED) {
            this.videoState = SendVideoState.PLAYING;
          }
          break;
        case window.WindowStageEventType.ACTIVE: // è·ç„¦çŠ¶æ€
          hilog.info(0x0000, 'testTag', `windowStage active.`);
          break;
        case window.WindowStageEventType.INACTIVE: // å¤±ç„¦çŠ¶æ€
          hilog.info(0x0000, 'testTag', `windowStage inactive.`);

          break;
        case window.WindowStageEventType.HIDDEN: // åˆ‡åˆ°åå°
          hilog.info(0x0000, 'testTag', `windowStage background.`);
          if (this.videoState === SendVideoState.PLAYING) {
            this.videoState = SendVideoState.PAUSED;
          }
          break;
        case window.WindowStageEventType.RESUMED: // å‰å°å¯äº¤äº’çŠ¶æ€
          hilog.info(0x0000, 'testTag', `windowStage resumed.`);
          if (this.videoState === SendVideoState.PAUSED) {
            this.videoState = SendVideoState.PLAYING;
          }
          break;
        case window.WindowStageEventType.PAUSED: // å‰å°ä¸å¯äº¤äº’çŠ¶æ€
          hilog.info(0x0000, 'testTag', `windowStage paused.`);
          if (this.videoState === SendVideoState.PLAYING) {
            this.videoState = SendVideoState.PAUSED;
          }
          break;
        default:
          break;
      }
    });
  }

  /**
   * æ ¹æ®è¿›å…¥åå°ç­‰è¿›è¡Œç›¸å…³çŠ¶æ€æ“ä½œã€‚
   */
  private windowStageEventTypeOne() {
    let context = getContext(this) as common.UIAbilityContext;
    context.windowStage.on('windowStageEvent', async (data) => {
      let stageEventType: window.WindowStageEventType = data;
      switch (stageEventType) {
        case window.WindowStageEventType.SHOWN: // åˆ‡åˆ°å‰å°
          if (this.jumpThreadAppState === JumpThreadAppState.JUMP_INTO_APP) {
            this.jumpThreadAppState = JumpThreadAppState.JUMP_BACK
          }
          if (this.videoState === SendVideoState.PAUSED) {
            //1ã€å¦‚æœæ˜¯è¿›å…¥äº†è½åœ°é¡µæˆ–åˆ™ä¸‰æ–¹åº”ç”¨
            if (this.jumpThreadAppState === JumpThreadAppState.JUMP_BACK) {
              //1ã€1å¦‚æœç«‹å³è·å¾—å¥–åŠ±==ã€‹ç‰¹æƒå¼¹çª—æ˜¾ç¤º
              if (this.rewardState === GetRewardedState.NOW_GET_REWARDED) {
                hilog.info(0x0000, 'testTag å¼¹å‡ºæ¥', "privilegeDialogAd");
                //ç¡®å®šå¼¹çª—æ˜¯å…³é—­çŠ¶æ€å†å¼¹å‡ºï¼Œå¯èƒ½ç”¨æˆ·æ²¡å…³é—­é€€å‡ºåå°ï¼Œæ­¤æ—¶ä¹Ÿéœ€è¦
                if (this.plgDialogState === PrivilegeDialogStatus.CLOSE) {
                  this.privilegeDialogAd()
                }
                //1ã€2å¦‚æœæ˜¯æ²¡æœ‰å¥–åŠ±æˆ–å·²ç»è·å¾—äº†å¥–åŠ±  ==ã€‹è®©å…¶æ­£å¸¸æ’­æ”¾
              } else if (this.rewardState === GetRewardedState.NOT_OBTAINABLE ||
                this.rewardState === GetRewardedState.ALREADY_OBTAINED) {
                this.jumpThreadAppState = JumpThreadAppState.JUMP_BEFORE
                this.videoState = SendVideoState.PLAYING
              }
              //2ã€éè¿›å…¥ä¸‰æ–¹APPæˆ–è€…è½åœ°é¡µï¼Œå¸¸è§„å¤„ç†å³å¯
            } else {
              if (this.plgDialogState === PrivilegeDialogStatus.CLOSE) {
                this.videoState = SendVideoState.PLAYING;
              }
            }
          }

          break;
        case window.WindowStageEventType.ACTIVE: // è·ç„¦çŠ¶æ€
          hilog.info(0x0000, 'testTag', `windowStage active.`);
          break;
        case window.WindowStageEventType.INACTIVE: // å¤±ç„¦çŠ¶æ€
          hilog.info(0x0000, 'testTag', `windowStage inactive.`);

          break;
        case window.WindowStageEventType.HIDDEN: // åˆ‡åˆ°åå°
          hilog.info(0x0000, 'testTag', `windowStage background.`);
          if (this.videoState === SendVideoState.PLAYING) {
            this.videoState = SendVideoState.PAUSED;
          }
          if (this.jumpThreadAppState === JumpThreadAppState.JUMP_BACK) {
            this.jumpThreadAppState = JumpThreadAppState.JUMP_BEFORE
          }
          break;
        case window.WindowStageEventType.RESUMED: // å‰å°å¯äº¤äº’çŠ¶æ€
          hilog.info(0x0000, 'testTag', `windowStage resumed.`);
          if (this.videoState === SendVideoState.PAUSED) {
            if (this.plgDialogState === PrivilegeDialogStatus.CLOSE) {
              this.videoState = SendVideoState.PLAYING;
            }
          }

          break;
        case window.WindowStageEventType.PAUSED: // å‰å°ä¸å¯äº¤äº’çŠ¶æ€
          hilog.info(0x0000, 'testTag', `windowStage paused.`);
          if (this.videoState === SendVideoState.PLAYING) {
            this.videoState = SendVideoState.PAUSED;
          }
          if (this.jumpThreadAppState === JumpThreadAppState.JUMP_BACK) {
            this.jumpThreadAppState = JumpThreadAppState.JUMP_BEFORE
          }
          break;
        default:
          break;
      }
    });
  }

  jumpThreadAppListener() {
    if (this.jumpThreadAppState === JumpThreadAppState.JUMP_START) {
      hilog.info(0x0000, 'testTag', `jumpThreadAppListener =${this.jumpThreadAppState}}`);
      this.jumpThreadAppState = JumpThreadAppState.JUMP_INTO_APP
      this.jumpTime = new Date().getTime()
    }
  }

  privilegeDialogAd() {
    if (this.jumpThreadAppState === JumpThreadAppState.JUMP_BACK) {
      let uiContext = this.getUIContext();
      let promptAction = uiContext.getPromptAction();
      let title = "æ­å–œè·å¾—ç‰¹æƒ"
      let sub = "ç»§ç»­ä½“éªŒå†…å®¹"
      this.showTime -= Math.floor((new Date().getTime() - this.jumpTime) / 1000)
      if (this.showTime <= 0) {
        this.videoState = SendVideoState.COMPLETE;
        this.jumpThreadAppState = JumpThreadAppState.JUMP_BEFORE
        this.rewardState = GetRewardedState.ALREADY_OBTAINED
        clearInterval(this.intervalId);
        return
      }
      let contentNode =
        new ComponentContent(uiContext, wrapBuilder(MPrDialogContentView),
          new Params(title, sub, this.showTime, this.videoModel, (state: JumpThreadAppState) => {
            this.plgDialogState === PrivilegeDialogStatus.CLOSE
            this.jumpThreadAppState = state
            promptAction.closeCustomDialog(contentNode).then(() => {
              this.plgDialogState = PrivilegeDialogStatus.CLOSE
            })
          }, () => {
            if (this.videoState === SendVideoState.PAUSED) {
              this.videoState = SendVideoState.PLAYING
            }
            this.jumpThreadAppState = JumpThreadAppState.JUMP_BEFORE
            hilog.info(0x0000, 'testTag', `privilegeDialogAd closeDialog =${this.jumpThreadAppState}}`);
            promptAction.closeCustomDialog(contentNode).then(() => {
              this.plgDialogState = PrivilegeDialogStatus.CLOSE
            })
          }, () => {
            //æ”¾å¼ƒç‰¹æƒ
            this.showTime = VideoTimeUtil.getShowTime(this.videoModel)
            if (this.videoState === SendVideoState.PAUSED) {
              this.videoState = SendVideoState.PLAYING
            }
            this.jumpThreadAppState = JumpThreadAppState.JUMP_BEFORE
            promptAction.closeCustomDialog(contentNode).then(() => {
              this.plgDialogState = PrivilegeDialogStatus.CLOSE
            })
          }, () => {
            promptAction.closeCustomDialog(contentNode).then(() => {
              this.plgDialogState = PrivilegeDialogStatus.CLOSE
            })
            clearInterval(this.intervalId)
            router.back()
          }));
      let options: promptAction.BaseDialogOptions = {
        alignment: DialogAlignment.Center,
        isModal: true,
        maskColor: "#7e090909",
        autoCancel: false,
        onWillDismiss: () => {
        }
      };
      try {
        promptAction.openCustomDialog(contentNode, options).then(() => {
          this.plgDialogState = PrivilegeDialogStatus.OPENING
        });
      } catch (error) {
        let message = (error as BusinessError).message;
        let code = (error as BusinessError).code;
        console.error(`OpenCustomDialog args error code is ${code}, message is ${message}`);
      }
    }
  }
}

export class Params {
  title: string = '';
  sub: string = ''
  time: number
  videoModel: VideoModel | undefined
  onClose: () => void
  onContinue: () => void
  onAbandonCall: () => void
  jumpAppStateCall: (state: JumpThreadAppState) => void

  constructor(text: string, sub: string, time: number, videoModel: VideoModel | undefined,
    jumpAppStateCall: (state: JumpThreadAppState) => void, onContinue: () => void, onAbandonCall: () => void,
    onClose: () => void) {
    this.title = text
    this.sub = sub
    this.time = time
    this.videoModel = videoModel
    this.onContinue = onContinue
    this.jumpAppStateCall = jumpAppStateCall
    this.onClose = onClose
    this.onAbandonCall = onAbandonCall
  }
}

@Builder
export function buildText(params: Params) {
  Column() {
    Text(params.title)
      .fontSize(16).margin({ top: 15 })
    Text(params.sub)
      .fontSize(16).margin({ top: 15 })
    Button("ç»§ç»­è§‚çœ‹").width('100%').fontSize(14).margin({ top: 20 }).onClick(() => {
      params.onContinue()
    })
    Text("å…³é—­å¹¿å‘Š")
      .fontSize(14)
      .fontColor(Color.Gray)
      .margin({ top: 20, bottom: 15 })
      .onClick(() => {
        params.onClose()
      })
  }
  .width('80%')
  .padding(24)
  .justifyContent(FlexAlign.Center)
  .alignItems(HorizontalAlign.Center)
  .backgroundColor(Color.White)
  .borderRadius(24)
}

@Builder
function MPrDialogContentView(params: Params): void {
  PrDialogContentView({ params, videoModel: params.videoModel })
}
